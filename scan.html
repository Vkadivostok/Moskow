<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Имитатор отсканированного PDF</title>
  <!-- Фавикон -->
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.png">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- pdf.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- pdf-lib.js CDN -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background-image: url('https://raw.githubusercontent.com/Vkadivostok/Moskow/main/images/Picsart_25-03-17_16-22-07-992.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    .toolbar, .settings-panel, .content-panel { 
      backdrop-filter: blur(5px);
      background: rgba(0, 0, 0, 0.5); /* Полупрозрачная темная подложка */
    }
    #pdf-canvas { 
      filter: grayscale(0%); 
      touch-action: pinch-zoom; 
      opacity: 0; 
      transition: opacity 0.5s ease-in-out; 
    }
    #pdf-canvas.loaded { 
      opacity: 1; 
    }
    .toolbar { 
      background: linear-gradient(to right, rgba(75, 85, 99, 0.8), rgba(31, 41, 55, 0.8)); 
    }
    .settings-panel { 
      transition: max-height 0.3s ease-in-out; 
      overflow: hidden; 
    }
    .settings-panel.hidden { 
      max-height: 0; 
    }
    .settings-panel:not(.hidden) { 
      max-height: 100px; 
    }
    #progress-container { 
      display: none; 
    }
    #progress-container.active { 
      display: block; 
    }
    @media (max-width: 640px) {
      .toolbar { 
        flex-direction: column; 
        align-items: flex-start; 
      }
      .toolbar-buttons { 
        flex-direction: row; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
        width: 100%; 
      }
      .toolbar-buttons button { 
        flex: 1; 
        min-width: 120px; 
      }
      #pdf-canvas { 
        max-height: 60vh; 
      }
      .nav-buttons button { 
        flex: 1; 
        min-width: 100px; 
      }
    }
    @media (min-width: 1280px) {
      .toolbar-buttons button { 
        padding: 0.75rem 1.5rem; 
        font-size: 1.125rem; 
      }
      .nav-buttons button { 
        padding: 0.75rem 1.5rem; 
        font-size: 1.125rem; 
      }
      #pdf-canvas { 
        max-height: 80vh; 
      }
    }
  </style>
</head>
<body>
  <div class="min-h-screen flex flex-col">
    <!-- Панель инструментов -->
    <div class="toolbar p-4 text-white">
      <div class="flex flex-col sm:flex-row justify-between items-center w-full">
        <h1 class="text-lg font-bold mb-2 sm:mb-0">Имитатор отсканированного PDF</h1>
        <div class="toolbar-buttons flex sm:space-x-2 flex-wrap gap-2">
          <input type="file" id="pdf-upload" accept="application/pdf" class="hidden" onchange="loadPDF(event)">
          <button onclick="document.getElementById('pdf-upload').click()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">Загрузить PDF</button>
          <button onclick="downloadPDF()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm">Скачать PDF</button>
        </div>
      </div>
    </div>

    <!-- Панель настроек -->
    <div class="flex flex-col">
      <div id="settings-panel" class="settings-panel w-full sm:w-64 bg-white p-4 shadow-lg">
        <div class="mb-4">
          <label class="flex items-center text-sm font-medium">
            <input type="checkbox" id="grayscale" class="mr-2" onchange="applyFilters()">
            Черно-белый фильтр
          </label>
        </div>
      </div>

      <!-- Основное содержимое -->
      <div class="flex-1 p-4">
        <div class="content-panel bg-white shadow-lg rounded-lg p-4">
          <canvas id="pdf-canvas" class="w-full max-h-[60vh] sm:max-h-[70vh] xl:max-h-[80vh] border"></canvas>
          <div class="nav-buttons flex justify-between mt-4">
            <button onclick="prevPage()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">Предыдущая</button>
            <span id="page-info" class="text-sm self-center">Страница 1 из 1</span>
            <button onclick="nextPage()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">Следующая</button>
          </div>
          <div id="progress-container" class="mt-4">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm text-center mt-2">Обработка...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.0;
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');

    async function loadPDF(event) {
      const file = event.target.files[0];
      if (!file) return;
      canvas.classList.remove('loaded'); // Скрываем канвас перед загрузкой
      const arrayBuffer = await file.arrayBuffer();
      pdfjsLib.getDocument(arrayBuffer).promise.then(pdf => {
        pdfDoc = pdf;
        pageNum = 1;
        document.getElementById('page-info').textContent = `Страница 1 из ${pdfDoc.numPages}`;
        renderPage(pageNum);
      });
    }

    function renderPage(num) {
      canvas.classList.remove('loaded'); // Скрываем канвас перед рендерингом
      pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        page.render({ canvasContext: ctx, viewport }).promise.then(() => {
          applyFilters();
          setTimeout(() => canvas.classList.add('loaded'), 50); // Плавное появление
        });
      });
      document.getElementById('page-info').textContent = `Страница ${num} из ${pdfDoc.numPages}`;
    }

    function applyFilters() {
      const grayscale = document.getElementById('grayscale').checked ? 100 : 0;
      canvas.style.filter = `grayscale(${grayscale}%)`;
    }

    function prevPage() {
      if (pageNum > 1) {
        pageNum--;
        renderPage(pageNum);
      }
    }

    function nextPage() {
      if (pageNum < pdfDoc.numPages) {
        pageNum++;
        renderPage(pageNum);
      }
    }

    async function downloadPDF() {
      if (!pdfDoc) return alert('Пожалуйста, сначала загрузите PDF.');
      
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      progressContainer.classList.add('active');
      progressText.textContent = 'Обработка PDF...';

      const newPdf = await PDFLib.PDFDocument.create();
      const grayscale = document.getElementById('grayscale').checked ? 1.0 : 0.0;

      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 4.0 }); // Высокое разрешение для четкости текста
        const tempCanvas = document.createElement('canvas');
        tempCanvas.height = viewport.height;
        tempCanvas.width = viewport.width;
        const tempCtx = tempCanvas.getContext('2d');

        // Установка белого фона
        tempCtx.fillStyle = 'white';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        await page.render({ canvasContext: tempCtx, viewport }).promise;

        // Применение черно-белого фильтра
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const data = imageData.data;

        for (let j = 0; j < data.length; j += 4) {
          let r = data[j];
          let g = data[j + 1];
          let b = data[j + 2];
          const a = data[j + 3];

          // Пропуск прозрачных пикселей (сохраняем белый фон)
          if (a === 0) continue;

          // Применение черно-белого фильтра
          if (grayscale > 0) {
            const lum = 0.299 * r + 0.587 * g + 0.114 * b;
            r = g = b = lum;
          }

          data[j] = r;
          data[j + 1] = g;
          data[j + 2] = b;
        }
        tempCtx.putImageData(imageData, 0, 0);

        // Повышение резкости текста (лапласиан)
        const sharpenedData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const sharpData = sharpenedData.data;
        const width = tempCanvas.width;
        const height = tempCanvas.height;

        const weights = [0, -1, 0, -1, 5, -1, 0, -1, 0]; // Простой лапласиан для повышения резкости
        const sharpenAmount = 0.7; // Сила резкости

        for (let y = 1; y < height - 1; y++) {
          for (let x = 1; x < width - 1; x++) {
            for (let c = 0; c < 3; c++) { // R, G, B
              const i = (y * width + x) * 4 + c;
              let sum = 0;
              for (let dy = -1; dy <= 1; dy++) {
                for (let dx = -1; dx <= 1; dx++) {
                  const ni = ((y + dy) * width + (x + dx)) * 4 + c;
                  sum += weights[(dy + 1) * 3 + (dx + 1)] * sharpData[ni];
                }
              }
              data[i] = Math.min(255, Math.max(0, sharpData[i] + sharpenAmount * (sharpData[i] - sum)));
            }
          }
        }
        tempCtx.putImageData(imageData, 0, 0);

        const imgData = tempCanvas.toDataURL('image/png', 1.0); // Максимальное качество PNG
        const imgBytes = await fetch(imgData).then(res => res.arrayBuffer());
        const img = await newPdf.embedPng(imgBytes);
        const newPage = newPdf.addPage([viewport.width, viewport.height]);
        newPage.drawImage(img, { x: 0, y: 0, width: viewport.width, height: viewport.height });

        // Обновление прогресса
        progressBar.style.width = `${(i / pdfDoc.numPages) * 100}%`;
        progressText.textContent = `Обработка страницы ${i} из ${pdfDoc.numPages}`;
      }

      const pdfBytes = await newPdf.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'отсканированный_pdf.pdf';
      a.click();
      URL.revokeObjectURL(url);

      progressContainer.classList.remove('active');
    }
  </script>
</body>
</html>
